<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-select=no">
    <title>æ€æˆç§¯åˆ†å­˜æŠ˜ ğŸ¾</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <style>
        :root { --blue: #1e88e5; --yellow: #fdd835; --bg: #f0f7ff; --white: #ffffff; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: #333; }
        .header { background: var(--blue); color: white; padding: 25px; text-align: center; font-size: 1.4rem; font-weight: bold; border-bottom: 5px solid var(--yellow); }
        .container { padding: 15px; max-width: 500px; margin: auto; }
        .card { background: var(--white); border-radius: 25px; padding: 20px; box-shadow: 0 8px 20px rgba(30,136,229,0.1); margin-bottom: 15px; border: 3px solid var(--yellow); position: relative; }
        .balance-box { text-align: center; background: linear-gradient(135deg, #fff 0%, #fffde7 100%); }
        .pts-val { font-size: 2.8rem; color: var(--blue); font-weight: 900; }
        .money-val { font-size: 1rem; color: #2e7d32; background: #e8f5e9; padding: 8px 15px; border-radius: 20px; margin-top: 10px; display: inline-block; font-weight: bold; border: 1px solid #a5d6a7; }
        
        /* æç°é¡µä¸“ç”¨æ ·å¼ */
        .withdraw-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .custom-withdraw-box { border-top: 2px dashed #eee; padding-top: 20px; margin-top: 10px; }
        
        .btn { background: var(--blue); border: none; color: white; padding: 14px; border-radius: 18px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; box-shadow: 0 4px 0 #1565c0; transition: 0.1s; display: flex; align-items: center; justify-content: center; }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-withdraw { background:#ffeb3b; color:#333; box-shadow: 0 4px 0 #fbc02d; }
        
        .fab { position: fixed; right: 20px; bottom: 100px; width: 65px; height: 65px; border-radius: 50%; background: var(--yellow); color: #333; font-size: 2.5rem; display: flex; align-items: center; justify-content: center; border: 4px solid var(--blue); z-index: 99; box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 25px; border-radius: 30px; width: 85%; max-width: 350px; }
        .face-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #video-feed { width: 260px; height: 260px; border-radius: 50%; object-fit: cover; border: 6px solid var(--yellow); margin-bottom: 20px; transform: scaleX(-1); }
        .progress-bar { width: 220px; height: 10px; background: #333; border-radius: 10px; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background: var(--yellow); transition: width 0.1s; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: var(--white); display: flex; padding: 12px 0; border-top: 4px solid var(--blue); z-index: 100; }
        .nav-item { text-align: center; color: #999; flex: 1; font-size: 0.8rem; cursor: pointer; }
        .nav-item.active { color: var(--blue); font-weight: bold; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 1rem; }
        .page { display: none; }
        .page.active { display: block; }
        .record-item { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 10px 0; align-items: center; }
        .plus { color: #2e7d32; font-weight: bold; }
        .minus { color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body>

<div class="header" id="ui-header">æ€æˆç§¯åˆ†å­˜æŠ˜</div>

<div class="container">
    <div id="page1" class="page active">
        <div class="card balance-box">
            <div id="ui-bal-label">ğŸ’° ç§¯åˆ†ä½™é¢</div>
            <div class="pts-val" id="totalPts">0.00</div>
            <div class="money-val" id="totalMoney">åŠ è½½ä¸­...</div>
        </div>
        <div id="recordList"></div>
    </div>

    <div id="page2" class="page">
        <div class="card" style="text-align: center;">
            <h2 id="ui-with-title">ğŸ§§ æç°ä¸­å¿ƒ</h2>
            <p style="font-size:0.8rem; color:#888; margin-bottom: 15px;">æ±‡ç‡ï¼š10 ç§¯åˆ† = 1 å…ƒç°é‡‘</p>
            
            <div class="withdraw-grid">
                <button class="btn btn-withdraw" onclick="confirmWithdraw(10)">ğŸ¦ 1 å…ƒ</button>
                <button class="btn btn-withdraw" onclick="confirmWithdraw(100)">ğŸ” 10 å…ƒ</button>
                <button class="btn btn-withdraw" onclick="confirmWithdraw(500)">ğŸ 50 å…ƒ</button>
                <button class="btn btn-withdraw" onclick="confirmWithdraw(1000)">ğŸï¸ 100 å…ƒ</button>
            </div>

            <div class="custom-withdraw-box">
                <p style="font-size:0.9rem; font-weight:bold; margin-bottom:5px;" id="ui-custom-label">è¾“å…¥è‡ªå®šä¹‰é‡‘é¢ (å…ƒ)</p>
                <input type="number" id="customCash" placeholder="0.00" step="0.1">
                <button class="btn" style="background:var(--blue);" onclick="handleCustomWithdraw()">ğŸš€ è‡ªå®šä¹‰é‡‘é¢æç°</button>
            </div>
        </div>
    </div>

    <div id="page3" class="page">
        <div class="card" style="text-align: center;">
            <div style="position: relative; width: 100px; height: 100px; margin: auto;">
                <img id="avatarImg" src="https://via.placeholder.com/150" style="width:100%; height:100%; border-radius:50%; object-fit:cover; border:3px solid var(--yellow);">
                <div style="position: absolute; bottom: 0; right: 0; background: white; border-radius: 50%; padding: 4px; border: 1px solid #ddd; cursor: pointer;" onclick="document.getElementById('fileInput').click()">ğŸ“¸</div>
            </div>
            <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFileSelect(this)">
            <h2 id="nameShow">æ€æˆ</h2>
            <select id="langSelect" onchange="changeLang(this.value)">
                <option value="zh">ç®€ä½“ä¸­æ–‡</option>
                <option value="tw">ç¹é«”ä¸­æ–‡</option>
                <option value="en">English</option>
            </select>
            <input type="text" id="newName" placeholder="ä¿®æ”¹åå­—...">
            <button class="btn" id="ui-btn-rename" onclick="rename()">âœ… ç¡®è®¤ä¿®æ”¹</button>
            <button class="btn" style="background:#ff5252; box-shadow: 0 4px 0 #d32f2f;" id="ui-btn-reset" onclick="reset()">ğŸ—‘ï¸ é‡ç½®æ•°æ®</button>
        </div>
    </div>
</div>

<button class="fab" id="fabBtn" onclick="openAddModal()">+</button>

<div id="confirmModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <h2 id="ui-conf-title">ç¡®è®¤æ”¯ä»˜</h2>
        <div id="confirmDetail" style="font-size: 1.4rem; margin: 15px 0; color: var(--blue); font-weight: bold;"></div>
        <p style="font-size:0.8rem; color:#888;">å³å°†å¼€å§‹é¢éƒ¨ç”Ÿç‰©è¯†åˆ«</p>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:#ccc; box-shadow: 0 4px 0 #999;" onclick="document.getElementById('confirmModal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn" id="ui-btn-startscan" onclick="proceedToFaceScan()">ç¡®è®¤å¹¶è¯†åˆ«</button>
        </div>
    </div>
</div>

<div id="faceModal" class="face-modal">
    <h2 id="ui-scan-title">èº«ä»½æ ¸éªŒ</h2>
    <video id="video-feed" autoplay playsinline></video>
    <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
    <p id="face-status">æ­£åœ¨æ‰«æ...</p>
</div>

<div id="addModal" class="modal">
    <div class="modal-content">
        <h3 id="ui-add-title">ğŸ“ æ·»åŠ è®°å½•</h3>
        <select id="recType"><option value="plus">å­˜å…¥ (+)</option><option value="minus">æ”¯å‡º (-)</option></select>
        <input type="number" id="recAmt" placeholder="ç§¯åˆ†æ•°é‡">
        <input type="text" id="recReason" placeholder="äº‹ç”±å¤‡æ³¨">
        <div style="display:flex; gap:10px;"><button class="btn" style="background:#ccc;" onclick="closeAddModal()">å–æ¶ˆ</button><button class="btn" onclick="doRecord()">ç¡®è®¤</button></div>
    </div>
</div>

<div id="cropperModal" class="modal">
    <div class="modal-content">
        <h3 id="ui-crop-title">è£å‰ªå¤´åƒ</h3>
        <div class="cropper-container-box"><img id="imageToCrop"></div>
        <div style="display:flex; gap:10px;"><button class="btn" style="background:#ccc;" onclick="closeCropper()">å–æ¶ˆ</button><button class="btn" onclick="saveCroppedAvatar()">ä¿å­˜</button></div>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="showP(1, this)" id="nav-1">ğŸ“– è´¦æœ¬</div>
    <div class="nav-item" onclick="showP(2, this)" id="nav-2">ğŸ§§ æç°</div>
    <div class="nav-item" onclick="showP(3, this)" id="nav-3">ğŸ˜ æˆ‘</div>
</div>

<script>
// --- å›½é™…åŒ–æ•°æ® ---
const i18n = {
    zh: { header: "æ€æˆç§¯åˆ†å­˜æŠ˜", bal_label: "ğŸ’° ç§¯åˆ†ä½™é¢", custom_label: "è¾“å…¥è‡ªå®šä¹‰é‡‘é¢ (å…ƒ)", with_title: "ğŸ§§ æç°ä¸­å¿ƒ", conf_title: "ç¡®è®¤æ”¯ä»˜", start_scan: "ç¡®è®¤å¹¶è¯†åˆ«", scan_title: "èº«ä»½æ ¸éªŒ", crop_title: "è£å‰ªå¤´åƒ", add_title: "ğŸ“ æ·»åŠ è®°å½•", nav1: "ğŸ“– è´¦æœ¬", nav2: "ğŸ§§ æç°", nav3: "ğŸ˜ æˆ‘", success: "ğŸ¤© è¯†åˆ«æˆåŠŸ", fail: "ğŸ§ åˆ«æŒ¡ç€è„¸", rename: "ç¡®è®¤ä¿®æ”¹", reset: "é‡ç½®æ•°æ®" },
    tw: { header: "æ€æˆç©åˆ†å­˜æŠ˜", bal_label: "ğŸ’° ç©åˆ†é¤˜é¡", custom_label: "è¼¸å…¥è‡ªå®šç¾©é‡‘é¡ (å…ƒ)", with_title: "ğŸ§§ æç¾ä¸­å¿ƒ", conf_title: "ç¢ºèªæ”¯ä»˜", start_scan: "ç¢ºèªä¸¦è­˜åˆ¥", scan_title: "èº«ä»½æ ¸é©—", crop_title: "è£å‰ªé ­åƒ", add_title: "ğŸ“ æ·»åŠ è¨˜éŒ„", nav1: "ğŸ“– å¸³æœ¬", nav2: "ğŸ§§ æç¾", nav3: "ğŸ˜ æˆ‘", success: "ğŸ¤© è­˜åˆ¥æˆåŠŸ", fail: "ğŸ§ åˆ¥æ“‹è‘—è‡‰", rename: "ç¢ºèªä¿®æ”¹", reset: "é‡ç½®æ•¸æ“š" },
    en: { header: "SiCheng Wallet", bal_label: "ğŸ’° Points Balance", custom_label: "Enter Custom Cash ($)", with_title: "ğŸ§§ Redeem", conf_title: "Confirm", start_scan: "Identify", scan_title: "Verification", crop_title: "Crop Avatar", add_title: "ğŸ“ New Entry", nav1: "ğŸ“– Book", nav2: "ğŸ§§ Redeem", nav3: "ğŸ˜ Me", success: "ğŸ¤© Verified!", fail: "ğŸ§ Blocked!", rename: "Update", reset: "Reset" }
};

// --- åˆå§‹åŒ–å˜é‡ ---
let db = JSON.parse(localStorage.getItem('sc_final_v15')) || {
    balance: 0.00, records: [], user: { name: 'æ€æˆ', avatar: '', lang: 'zh' }
};
let cropper = null;
let currentPendingPts = 0;
let stream = null;
let faceCheckTimer = null;
const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';

async function init() {
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    render();
}

function save() { localStorage.setItem('sc_final_v15', JSON.stringify(db)); render(); }

function render() {
    const lang = i18n[db.user.lang];
    document.getElementById('ui-header').innerText = lang.header;
    document.getElementById('ui-bal-label').innerText = lang.bal_label;
    document.getElementById('ui-with-title').innerText = lang.with_title;
    document.getElementById('ui-conf-title').innerText = lang.conf_title;
    document.getElementById('ui-btn-startscan').innerText = lang.start_scan;
    document.getElementById('ui-scan-title').innerText = lang.scan_title;
    document.getElementById('ui-crop-title').innerText = lang.crop_title;
    document.getElementById('ui-add-title').innerText = lang.add_title;
    document.getElementById('ui-custom-label').innerText = lang.custom_label;
    document.getElementById('ui-btn-rename').innerText = lang.rename;
    document.getElementById('ui-btn-reset').innerText = lang.reset;
    document.getElementById('nav-1').innerText = lang.nav1;
    document.getElementById('nav-2').innerText = lang.nav2;
    document.getElementById('nav-3').innerText = lang.nav3;
    
    document.getElementById('totalPts').innerText = db.balance.toFixed(0);
    const rmbValue = db.balance / 10;
    document.getElementById('totalMoney').innerText = `ğŸ’´ ç­‰å€¼ RMBï¼š${rmbValue.toFixed(2)} å…ƒ`;
    
    document.getElementById('nameShow').innerText = db.user.name;
    document.getElementById('langSelect').value = db.user.lang;
    if(db.user.avatar) document.getElementById('avatarImg').src = db.user.avatar;
    
    const list = document.getElementById('recordList');
    list.innerHTML = '';
    db.records.forEach(r => {
        const div = document.createElement('div');
        div.className = 'card record-item';
        div.innerHTML = `<div><b>${r.reason}</b><br><small>${r.time}</small></div><div class="${r.type}">${r.type==='plus'?'+':'-'}${r.amount.toFixed(0)}</div>`;
        list.appendChild(div);
    });
}

// --- æç°é€»è¾‘ ---
function handleCustomWithdraw() {
    const cash = parseFloat(document.getElementById('customCash').value);
    if(isNaN(cash) || cash <= 0) return alert("è¯·è¾“å…¥æ­£ç¡®çš„é‡‘é¢å“¦");
    const ptsRequired = cash * 10; // æ±‡ç‡ï¼š1å…ƒ = 10ç§¯åˆ†
    confirmWithdraw(ptsRequired);
}

function confirmWithdraw(pts) {
    if(db.balance < pts) return alert(`ç§¯åˆ†ä¸è¶³ï¼æç°éœ€è¦ ${pts.toFixed(0)} ç§¯åˆ†`);
    currentPendingPts = pts;
    document.getElementById('confirmDetail').innerText = `æ”¯ä»˜ ${pts.toFixed(0)} ç§¯åˆ† (æ¢å– ${(pts/10).toFixed(2)} å…ƒ)`;
    document.getElementById('confirmModal').style.display = 'flex';
}

async function proceedToFaceScan() {
    document.getElementById('confirmModal').style.display = 'none';
    const video = document.getElementById('video-feed');
    const fill = document.getElementById('progress-fill');
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        document.getElementById('faceModal').style.display = 'flex';
        let prog = 0;
        faceCheckTimer = setInterval(async () => {
            const detect = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
            if(detect) { 
                prog += 4; 
                document.getElementById('face-status').innerText = i18n[db.user.lang].success;
            } else { 
                if(prog > 0) prog -= 2; 
                document.getElementById('face-status').innerText = i18n[db.user.lang].fail;
            }
            fill.style.width = prog + '%';
            if(prog >= 100) { clearInterval(faceCheckTimer); finishWithdraw(); }
        }, 100);
    } catch(e) { alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™"); }
}

function finishWithdraw() {
    db.balance -= currentPendingPts;
    const now = new Date();
    db.records.unshift({ 
        type: 'minus', 
        amount: currentPendingPts, 
        reason: `å…‘æ¢ç°é‡‘ ${(currentPendingPts/10).toFixed(2)}å…ƒ`, 
        time: `${now.getMonth()+1}/${now.getDate()}` 
    });
    if(stream) stream.getTracks().forEach(t => t.stop());
    document.getElementById('faceModal').style.display = 'none';
    document.getElementById('customCash').value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
    save(); alert("ğŸŠ æç°æˆåŠŸï¼ç°é‡‘å·²åˆ°è´¦");
}

// --- åŸºç¡€è¾…åŠ©åŠŸèƒ½ ---
function showP(n, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.getElementById('page'+n).classList.add('active'); el.classList.add('active');
    document.getElementById('fabBtn').style.display = (n === 1) ? 'flex' : 'none';
}

function openAddModal() { document.getElementById('addModal').style.display = 'flex'; }
function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }
function doRecord() {
    const type = document.getElementById('recType').value;
    const amt = parseInt(document.getElementById('recAmt').value);
    const reas = document.getElementById('recReason').value || 'æ—¥å¸¸è®°å½•';
    if(isNaN(amt) || amt <= 0) return;
    if(type === 'minus' && db.balance < amt) return alert('ä½™é¢ä¸è¶³');
    db.balance = (type === 'plus') ? db.balance + amt : db.balance - amt;
    const now = new Date();
    db.records.unshift({ type, amount: amt, reason: reas, time: `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}` });
    closeAddModal(); save();
}

function handleFileSelect(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = document.getElementById('imageToCrop');
            img.src = e.target.result;
            document.getElementById('cropperModal').style.display = 'flex';
            if(cropper) cropper.destroy();
            cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 });
        };
        reader.readAsDataURL(input.files[0]);
    }
}
function saveCroppedAvatar() {
    db.user.avatar = cropper.getCroppedCanvas({width:200,height:200}).toDataURL();
    save(); document.getElementById('cropperModal').style.display = 'none';
}
function closeCropper() { document.getElementById('cropperModal').style.display = 'none'; }
function changeLang(v) { db.user.lang = v; save(); }
function rename() { const n = document.getElementById('newName').value; if(n) { db.user.name = n; save(); } }
function reset() { if(confirm('ç¡®å®šé‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) { localStorage.clear(); location.reload(); } }

init();
</script>
</body>
</html>